<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <title>Software Carpentry: R 병렬 프로그래밍</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-59802572-19', 'auto');
      ga('send', 'pageview');
    
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="http://software-carpentry.org" title="Software Carpentry">
          <img alt="Software Carpentry banner" src="img/software-carpentry-banner.png" />
        </a>
      </div>
      <article>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
                    <a href="index.html"><h1 class="title">R 병렬 프로그래밍</h1></a>
          <h2 class="subtitle">배포(deployment) = 기계학습 모형 사용</h2>
          <h1 id="r-deployment-hard">ML 모형을 실운영계로 적용 <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></h1>
<p>기계학습(ML) 모형을 실운영계에 적용시킨다는 것의 의미는 개발된 예측모형을 누군가 사용하도록 만든다는 의미가 된다. 즉, 누군가 기계학습 모형을 예측에 사용하게 된다. 그럼 어떻게 사용하게 할 수 있을까?</p>
<p>크게 배치(batch) 모형과 실시간(real-time) 두가지 방식으로 나눌 수 있다. 배치모형은 아래 데이터베이스 모형으로 간주되고, 실시간 모형은 <code>RESTful API</code> 모형으로 구현된다.</p>
<p>그런데 왜 배포가 어려운가? 이 문제를 생각해 보면 기계학습 모형을 운영계에 적용시킬 경우 다양한 기술과 전문성이 요구되기 때문이다. 이 말을 풀어서 보면 많은 사람이 기계학습 모형 배포과정에 가담하게 되면 자동으로 많은 문제가 야기된다.</p>
<ul>
<li>사업(Business)</li>
<li>데이터 과학(Data Science)</li>
<li>데이터 엔지니어링(Data Engineering)</li>
<li>운영(Operation)</li>
</ul>
<p>사람과 관련된 이슈 외에도 기술적으로 너무나도 많은 다양한 선택지가 존재하는 것도 이슈다.</p>
<ul>
<li>Spark ML</li>
<li>dbml</li>
<li>PMML</li>
<li>PFA/Aardpfark</li>
<li>MLeap</li>
<li>ONNX</li>
<li>성능문제로 C/C++로 재구현</li>
</ul>
<h1 id="r-in-production">예측모형 양산환경 <a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></h1>
<p>웹에서 R을 돌리는 방법은 오래전부터 많이 시도되어 왔고, 이제는 안정화되었다고 봐도 될듯 싶다. 한동안 <code>opencup</code>가 많이 사용되어 왔으나 팩키지를 만들어야 기본적으로 R을 양산환경에 돌릴 수 있다는 부담감(?)으로 작용하는 것도 사실이다. 최근에는 <code>plumber</code>가 대세로 굳어지는 듯 하다. <a href="http://fishyoperations.com/2018/01/07/discontinuing-maintenance-jug.html">Discontinuing maintenance of jug</a>를 발표하면서 더이상 <code>jug</code>가 RESTful API 개발을 주도하는데 실패했고, 이에 대한 대안으로 <a href="https://github.com/trestletech/plumber">plumber</a>를 추천하고 있다.</p>
<ul>
<li><code>plumber</code>: <a href="https://github.com/trestletech/plumber">Turn your R code into a web API</a></li>
<li><code>jug</code>: <a href="https://github.com/Bart6114/jug">jug: A Simple Web Framework for R</a></li>
<li><code>opencpu</code>: <a href="https://www.opencpu.org/">OpenCPU system for embedded scientific computation and reproducible research</a>
<ul>
<li>팩키지를 개발하고 이를 RESTful API 서비스로 제공.</li>
</ul></li>
<li><code>deployR</code>: <a href="http://blog.revolutionanalytics.com/2016/09/the-elements-of-scaling-r-based-applications-with-deployr.html">The elements of scaling R-based applications with DeployR</a>
<ul>
<li>마이크로소프트에서 개발하여 제공.</li>
</ul></li>
<li><code>rapache</code>: <a href="http://rapache.net/">Web Application Development with R and Apache</a>
<ul>
<li>오래전에 개발된 후에 더이상 활발히 개발이 진행되고 있지 않는 것으로 파악됨.</li>
</ul></li>
</ul>
<p><img src="fig/database-restful-api-in-production.png" alt="두가지 예측모형 양산 아키텍쳐" width="57%" /></p>
<p>기계학습, 딥러닝을 통해 학습한 예측모형을 양산환경으로 배포할 경우 크게 두가지 아키텍쳐가 가능하다. 일반적인 상용 웹사이트 사례를 들어 예측모형 양산환경에 대해서 살펴보자. <a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a></p>
<table style="width:93%;">
<colgroup>
<col width="6%" />
<col width="43%" />
<col width="43%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">구분</th>
<th align="left">데이터베이스</th>
<th align="left">RESTful API</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">장점</td>
<td align="left">데이터베이스 테이블을 단순히 병합(Join)하면 되기 때문에 속도가 매우 빠름</td>
<td align="left">유닉스 철학에 따라 예측서비스를 독자적 수행이 가능</td>
</tr>
<tr class="even">
<td align="left">단점</td>
<td align="left">커플링 되어 있어 일부 코드 변경을 위해서 시간이 추가로 소요되고, 한가한 시간에 배치로 테이블 예측값을 주기적 갱신</td>
<td align="left">속도가 늦을 수 있으나 대부분의 웹사이트는 비동기식 통신을 통해 예측모형 외에 다양한 서비스를 조합해서 서비스함</td>
</tr>
</tbody>
</table>
<p>RESTful API로 예측모형 양산 서비스를 제공할 경우 복잡한 예측모형만큼이나 난잡한 예측모형 양산 서비스를 이해하기 쉽게 할 수 있고, 유지보수하기도 쉽고, 예측모형에 대한 버젼관리 뿐만 아니라 모니터링도 한결 수월하게 진행할 수 있다.</p>
<aside class="callout panel panel-info">
<div class="panel-heading">
<h3 id="opencpu-와-다른-웹도구와-차별점-so-opencpu"><span class="glyphicon glyphicon-pushpin"></span>OpenCPU 와 다른 웹도구와 차별점 <a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></h3>
</div>
<div class="panel-body">
<p>OpenCPU is a layer on top of the regular tools (e.g. RApache, rpy2) that defines a framework and protocol for interacting with R. It handles stuff like object serialization, security, resource control, reproducibility etc, while abstracting away technicalities.</p>
</div>
</aside>
<p><img src="fig/api-plumber-api.png" alt="R RESTful API 개발환경" width="100%" /></p>
<h1 id="local-computer-api">예측모형 RESTful API 서비스로 제공</h1>
<p>기계학습 예측모형을 예측하려는 변수를 연속형 변수와 범주형변수로 나눠 적절한 모형 아키텍처를 선택하고 나서 예측모형의 성능을 나타내는 지표 <code>RMSE</code>, <code>ROC AUC</code>, 정확도(accuracy)등을 가지고 모형의 복잡성 등을 평가하고 나서 최적의 예측모형을 선택한다. <code>xgBoost</code>, <code>Random Forest</code>, <code>GBM</code>, <code>CART</code>, <code>GLM</code> 등이 예측모형이 될 수 있다.</p>
<p>다음 단계로 이를 <code>RESTful</code> API로 변환을 시킨다. 이때, <code>plumber</code>, <code>openCPU</code>가 검토 대상이 될 수 있다.</p>
<p>이제 예측모형을 RESTful API로 제공할 준비가 되었다면 다음 단계로 이를 AWS 혹은 Digital Ocean에 서버를 임차하여 배포한다. 이제 서버에 예측서비스를 요청하면 결과를 제공받을 수 있게 되었다.</p>
<h2 id="local-computer-api">로컬 컴퓨터 RESTful API 개발 환경</h2>
<p>예를 들어 <code>plumber</code>를 RESFtul API 기본 서버로 지정하는 경우 로컬컴퓨터에서 <code>httr</code> 팩키지가 지원하는 <code>GET</code>, <code>POST</code> 함수를 활용하여 <code>plumber</code> 팩키지가 R 코드를 서비스로 제공하도록 개발환경을 구축한다.</p>
<p>로컬 컴퓨터에 <code>plumber</code> 개발환경을 구축하는 방법은 다음과 같이 단순하다.</p>
<p><code>devtools::install_github(&quot;trestletech/plumber&quot;)</code> 명령어로 R코드를 RESTful API로 제공하는 팩키지를 설치한다. 제공할 서비스를 <code>myfile.R</code> 파일에 담아 넣고 <code>POST</code>, <code>GET</code>으로 서비스를 명세한다. <code>r$run(port=8000)</code> 명령어를 실행해서 <code>myfile.R</code> 파일에 담아 놓은 서비스를 RESTful API로 제공한다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;trestletech/plumber&quot;</span>)

<span class="kw">library</span>(plumber)

r &lt;-<span class="st"> </span><span class="kw">plumb</span>(<span class="st">&quot;code/myfile.R&quot;</span>) 
r$<span class="kw">run</span>(<span class="dt">port=</span><span class="dv">8000</span>)
Starting server to listen on port <span class="dv">8000</span>
Running the swagger UI at http:<span class="er">//</span><span class="fl">127.0.0.1</span>:<span class="dv">8000</span>/__swagger__/</code></pre></div>
<h2 id="local-computer-api-pm">예측 모형 개발</h2>
<p>기계학습 예측모형 개발에 대한 독일신용평가 데이터를 활용한 모형개발 사례는 <a href="http://statkclee.github.io/ml/ml-model-selection.html">xwMOOC 기계학습 - 모형식별 및 선택 (yardstick)</a>을 참조한다.</p>
<p>그외 예측모형 개발 기계학습에 대한 일반적인 내용은 다음 xwMOOC 웹페이지를 참조한다.</p>
<ul>
<li><a href="http://statkclee.github.io/ml/">xwMOOC 기계학습 - 데이터 과학자가 바라본 기계학습</a></li>
</ul>
<h2 id="local-computer-api-pm-convert">예측 모형 → RESTful API 서비스 변환</h2>
<p>기계학습 예측모형 개발이 완료되었다면 다음 단계로 이를 <code>RESTful</code> API 서비스로 변환을 한다. 이에 대한 자세한 사항은 다음 두 사례를 참조한다.</p>
<ul>
<li><a href="http://statkclee.github.io/parallel-r/r-credit-score-api.html">R 병렬 프로그래밍 - 신용위험 확률(plumber) API</a></li>
<li><a href="http://statkclee.github.io/parallel-r/r-in-production-plumber.html">R 병렬 프로그래밍 - R 양산환경(plumber) - 타이타닉</a></li>
</ul>
<h2 id="digital-aws-restful-api">AWS EC2/디지털바다 RESTful API 서비스</h2>
<p>로컬 컴퓨터에서 RESTful API 서비스를 개발하여 테스트를 마무리했다면, 로컬 컴퓨터에 가상컴퓨터를 생성하거나, 클라우드에 예를 들어 AWS EC2 컴퓨터에 <code>plumber</code> 팩키지를 설치하여 RESTful API 서비스를 제공하도록 탈바꿈 한다.</p>
<p><a href="https://cran.r-project.org/web/packages/analogsea/">analogsea: Interface to ‘Digital Ocean’</a>를 활용하면 GUI 대신 R RESTful API가 제공되는 서비스를 RStudio 콘솔 CLI를 통해 가상컴퓨터로 제공할 수 있다.</p>
<div class="row">
<div class="col-md-6">
<ul>
<li><strong>Plumber Server Provisioning on DigitalOcean</strong></li>
</ul>
<iframe width="300" height="180" src="https://www.youtube.com/embed/OiREOPog3Cs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
</div>
<div class="col-md-6">
<ul>
<li><strong>Adding HTTPS to Plumber on DigitalOcean</strong></li>
</ul>
<iframe width="300" height="180" src="https://www.youtube.com/embed/EpgdrRTBZwg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://sais2018.netlify.com/">Kevin Kuo (Jun 5, 2018), “From Prototyping to Deployment at Scale with R and sparklyr”, Spark+AI Summit</a><a href="#fnref1">↩</a></p></li>
<li id="fn2"><p><a href="https://www.quora.com/How-do-I-expose-R-code-as-a-web-service">How do I expose R code as a web service?</a><a href="#fnref2">↩</a></p></li>
<li id="fn3"><p><a href="https://raybuhr.github.io/2017/10/making-predictions-over-http/">raybuhr blog, Making Predictions over HTTP with R October 17, 2017</a><a href="#fnref3">↩</a></p></li>
<li id="fn4"><p><a href="https://stackoverflow.com/questions/8858429/whats-the-intention-of-opencpu-org-compared-to-other-approaches/8916615#8916615">What is the intention of opencpu.org compared to other approaches?</a><a href="#fnref4">↩</a></p></li>
</ol>
</div>
        </div>
      </div>
      </article>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/swcarpentry/lesson-template">Source</a>
        <a class="label swc-blue-bg" href="mailto:admin@software-carpentry.org">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-37305346-2', 'auto');
      ga('send', 'pageview');
    
    </script>
  </body>
</html>
