<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <title>Software Carpentry: R 병렬 프로그래밍</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-59802572-19', 'auto');
      ga('send', 'pageview');
    
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="http://software-carpentry.org" title="Software Carpentry">
          <img alt="Software Carpentry banner" src="img/software-carpentry-banner.png" />
        </a>
      </div>
      <article>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
                    <a href="index.html"><h1 class="title">R 병렬 프로그래밍</h1></a>
          <h2 class="subtitle">RESTful API 개발환경 - plumber</h2>
          <h1 id="plumber-api-test">RESTful API <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></h1>
<p>R 코드를 RESTful API 서비스로 제공하고자 할 경우 정말 훌륭한 서비스를 만드는 것도 중요하지만, 결국 시작은 헬로월드를 찍는 것부터 시작된다. 즉, RESTful API로 개발된 결과물을 빨리 확인할 수 있는 통합개발환경이 중요한 역할을 담당하게 된다.</p>
<p><img src="fig/plumber-restful-api-service.png" alt="plumber 서비스" width="100%" /></p>
<h2 id="plumber-api-test-curl"><code>curl</code> API 테스트 <a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></h2>
<p>RESTful API 서비스를 제작하는 것과 별도로 제작된 서비스가 제대로 된 것인지 점검하는 과정이 필요하다. 이를 위해서 <a href="https://curl.haxx.se/"><code>curl</code></a>을 흔히 사용하는데 기본적인 사용법을 익혀두는 것이 좋다.</p>
<p><code>curl</code>은 소프트웨어로 맥이나 리눅스에는 기본으로 장착되어 있어 별도 설치가 필요없지만, 윈도우 사용자의 경우 <a href="https://gitforwindows.org/">Git Bash</a>를 다운로드 받아 별도 설치를 하면 된다. <code>curl</code> 기본적인 사용법은 다음 동영상을 참조한다.</p>
<iframe width="300" height="180" src="https://www.youtube.com/embed/7XUibDYw4mc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
</iframe>
<p>RESTful API 개발과 테스트에 많이 사용되는 명령어는 다음과 같다. 특히, <a href="https://jsonplaceholder.typicode.com/">{ JSON : Placeholder }, Fake Online REST API for Testing and Prototyping Serving ~200 millions API requests per month</a> 사이트에서 동영상으로 학습한 내용을 실습하는 것도 가능하다.</p>
<ul>
<li>단순 GET 요청
<ul>
<li><code>curl https://jsonplaceholder.typicode.com/posts</code></li>
<li><code>curl https://jsonplaceholder.typicode.com/posts/1</code></li>
</ul></li>
<li>헤더(header) 정보 포함 (–include, -i)
<ul>
<li><code>curl --include https://jsonplaceholder.typicode.com/posts/1</code></li>
</ul></li>
<li>헤더(header) 정보만 가져오기 (–head, -I)
<ul>
<li><code>curl --head https://jsonplaceholder.typicode.com/posts/1</code></li>
</ul></li>
<li>파일로 저장 (-o, –output)
<ul>
<li><code>curl -o test.txt https://jsonplaceholder.typicode.com/posts/1</code></li>
</ul></li>
<li>바이너리 파일 저장 (-O, –remote-name)
<ul>
<li><code>curl -O http://i.imgur.com/QRlAg0b.png</code></li>
</ul></li>
<li>매개변수를 통한 데이터 전달 : POST (-d, –data)
<ul>
<li><code>curl -d &quot;title=Hello&amp;body=Hello World&quot; https://jsonplaceholder.typicode.com/posts</code></li>
</ul></li>
<li>PUT Data (-X PUT -d)
<ul>
<li><code>curl -X PUT -d &quot;title=Hello&amp;body=Hello World&quot; https://jsonplaceholder.typicode.com/posts/1</code></li>
</ul></li>
<li>데이터 삭제 (-X DELETE)
<ul>
<li><code>curl -X DELETE https://jsonplaceholder.typicode.com/posts/1</code></li>
</ul></li>
<li>Redirection 적용 (-L)
<ul>
<li><code>curl http://google.com</code> # 원하는 바를 얻지 못함.</li>
<li><code>curl -L http://google.com</code></li>
</ul></li>
</ul>
<h1 id="plumber-api-test-hello">헬로월드</h1>
<p>가장 먼저 <code>hello_world</code> 함수를 <code>/hello_world</code> 서비스로 제공한다. <code>httr</code> 팩키지 <code>GET</code> 함수를 활용하여 웹브라우져를 열어 테스트하는 대신 RStudio 개발환경에서 일원화하여 개발속도를 가속시킨다.</p>
<h2 id="plumber-api-hello-world">헬로월드 서비스 코드</h2>
<p>API 서비스 코드를 다음과 같이 작성한다. 즉, <code>http://localhost:8000/hello_world</code>를 끝점으로 설정하여 서비스를 제공하는데, 요청하면 “안녕하세요… 반갑습니다.” 메시지가 전달된다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#* @get /hello_world</span>
hello_world &lt;-<span class="st"> </span>function() {
    <span class="kw">return</span>(<span class="st">&quot;안녕하세요... 반갑습니다.&quot;</span>)
}</code></pre></div>
<p>헬로월드 서비스 호출 및 테스트를 R 콘솔 방식으로 혹은 터미널에서 수행하는 방식이 있다. 먼저 R 코드를 통해 <code>httr</code> 팩키지 <code>GET()</code>함수로 요청해서 결과를 받을 수도 있다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 0. 환경설정 ---------------------------------</span>
<span class="kw">library</span>(httr)
<span class="kw">library</span>(tidyverse)

<span class="co"># 1. 헬로 월드: GET ---------------------------------</span>
<span class="kw">GET</span>(<span class="st">&quot;http://localhost:8000/hello_world&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">content</span>()</code></pre></div>
<pre class="output"><code>$error
$error[[1]]
[1] &quot;404 - Resource Not Found&quot;
</code></pre>
<p>또 다른 방식은 <code>curl</code> 명령어를 사용하는 것도 있다. 이것이 좋은 이유는 RStudio에서 RESTful API 서비스를 제공하게 되면 다른 작업을 할 수가 없어 별도 RStudio를 띄워 놔야 하거나 하는 번거러움이 있지만, <code>curl</code>을 사용하게 되면 <code>Alt + T</code> 단축키로 터미널에서 <code>curl</code> 명령어로 테스트를 바로 할 수 있다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">curl http:<span class="er">//</span>localhost:<span class="dv">8000</span>/hello_world</code></pre></div>
<pre class="output"><code>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed

  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100    38  100    38    0     0   3256      0 --:--:-- --:--:-- --:--:--  3454
{&quot;error&quot;:[&quot;404 - Resource Not Found&quot;]}
</code></pre>
<h2 id="plumber-api-hello-world-parameter">매개변수 넘기는 경우</h2>
<p>단순히 서비스를 호출하는 대신에 인증을 위해 <code>ID</code>, <code>비밀번호</code>등을 넘기는 경우도 흔하다. 이런 경우 인자를 넘기는 방식이 다양하다. POST를 전통적으로 <code>?</code>로 시작해서 인자를 넘긴다고 지정하고 다수 매개변수를 넘길 때 매개변수를 <code>&amp;</code>로 구분해서 넘긴다.</p>
<p>혹은 POST 내부 인자로 <code>query</code>를 사용해서 <code>list</code> 자료형으로 넘기는 것도 가능하고, <code>path</code>에 지정하는 것도 가능하다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#* @post /sum_two</span>
plus_operation &lt;-<span class="st"> </span>function(a, b) {
    <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">result =</span> <span class="kw">as.numeric</span>(a) +<span class="st"> </span><span class="kw">as.numeric</span>(b)))
}

<span class="co">#* @get /iris/&lt;sp&gt;/&lt;n:int&gt;</span>
function(n, sp) {
    iris %&gt;%<span class="st"> </span>dplyr::<span class="kw">filter</span>(Species ==<span class="st"> </span>sp) %&gt;%<span class="st"> </span>
<span class="st">        </span>.[<span class="kw">as.integer</span>(n), ]
}</code></pre></div>
<p>매개변수 넘기는 API 테스트코드를 다음과 같이 작성하는 방식도 있다.</p>
<div class="row">
<div class="col-md-6">
<p><strong>R 콘솔</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 2. 매개변수 넘기기: POST ---------------------------------</span>
## 2.1. 매개변수 2개 넘겨 더하기
<span class="kw">POST</span>(<span class="st">&quot;http://localhost:8000/sum_two?a=1&amp;b=2&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">content</span>()</code></pre></div>
<pre class="output"><code>$error
$error[[1]]
[1] &quot;404 - Resource Not Found&quot;
</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#POST(&quot;http://localhost:8000/sum_two&quot;, query=list(a=1, b=3)) %&gt;% </span>
<span class="co">#    content()</span></code></pre></div>
</div>
<div class="col-md-6">
<p><strong>터미널</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">curl -d <span class="st">&quot;a=1&amp;b=2&quot;</span> http:<span class="er">//</span>localhost:<span class="dv">8000</span>/sum_two</code></pre></div>
<pre class="output"><code>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed

  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100    45  100    38  100     7   2626    483 --:--:-- --:--:-- --:--:--  2714
{&quot;error&quot;:[&quot;404 - Resource Not Found&quot;]}
</code></pre>
</div>
</div>
<p>경로명으로 매개변수를 넘기는 것도 가능하다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## 2.2. 깔끔한 매개변수 넘기기
<span class="kw">GET</span>(<span class="st">&quot;http://localhost:8000&quot;</span>, <span class="dt">path =</span> <span class="st">&quot;iris/virginica/3&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">content</span>()</code></pre></div>
<pre class="output"><code>$error
$error[[1]]
[1] &quot;404 - Resource Not Found&quot;
</code></pre>
<h1 id="plumber-api-graph">그래프</h1>
<h2 id="plumber-api-graph-viz">그래프 시각화를 하는 API</h2>
<p>단순히 문자와 숫자를 주고받는 것 뿐만 아니라 R의 강점인 그래프도 가능하다. 먼저 시각화하는 함수를 <code>ggp2dens()</code> 함수로 작성하고 끝점으로 <code>ggplot2_density</code>로 노출시킨다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#* @get /ggplot2_density</span>
<span class="co">#* @png</span>
ggp2dens &lt;-<span class="st"> </span>function(<span class="dt">seed =</span> <span class="kw">rnorm</span>(<span class="dv">1</span>), <span class="dt">fill.colour =</span> <span class="st">&quot;tomato&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span>) {
    <span class="kw">set.seed</span>(seed)
    <span class="kw">library</span>(ggplot2)
    p &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">rnorm</span>(<span class="dv">100</span>)) %&gt;%<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x)) +<span class="st"> </span>
<span class="st">        </span><span class="kw">geom_density</span>(<span class="dt">fill =</span> fill.colour, <span class="dt">alpha =</span> alpha)
    <span class="kw">print</span>(p)
}</code></pre></div>
<p>그래프 시각화를 하는 API 테스트를 다음과 같이 각각 작성한다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 3. 그래프 ---------------------------------</span>
<span class="kw">plot</span>(<span class="dv">0</span>:<span class="dv">1</span>, <span class="dv">0</span>:<span class="dv">1</span>, <span class="dt">type =</span> <span class="st">&quot;n&quot;</span>)</code></pre></div>
<p><img src="fig/plumber-restful-api-graph-test-1.png" title="plot of chunk plumber-restful-api-graph-test" alt="plot of chunk plumber-restful-api-graph-test" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">GET</span>(<span class="st">&quot;http://localhost:8000/ggplot2_density?seed=77&amp;fill.colour=tomato&amp;alpha=0.5&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">content</span>() %&gt;%<span class="st"> </span><span class="kw">rasterImage</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>)</code></pre></div>
<pre class="error"><code>Error in UseMethod(&quot;as.raster&quot;): 클래스 &quot;list&quot;의 객체에 적용된 &#39;as.raster&#39;에 사용할수 있는 메소드가 없습니다
</code></pre>
<h1 id="plumber-api-graph-interactive">인터랙티브 그래프</h1>
<h2 id="plumber-api-graph-viz-interactive">인터랙티브 그래프 API</h2>
<p>정적 그래프는 물론이고 인터랙티브 그래프도 가능하다. <code>htmlwidget</code>인 <code>dygraph()</code>를 동원해서 태양흑점 데이터를 인터랙티브하게 시각화해보자.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; @get /spots/&lt;year&gt;/graph</span>
<span class="co">#&#39; @serializer htmlwidget</span>
function(year){
    <span class="kw">dygraph</span>(datasets::sunspots, <span class="dt">main =</span> <span class="st">&quot;Sunspots&quot;</span>) %&gt;%
<span class="st">        </span><span class="kw">dyRangeSelector</span>(<span class="dt">dateWindow =</span> <span class="kw">c</span>(<span class="kw">paste0</span>(year,<span class="st">&quot;-01-01&quot;</span>),
                                       <span class="kw">paste0</span>(year,<span class="st">&quot;-12-31&quot;</span>))
        )
}</code></pre></div>
<p>인터랙티브 그래프 시각화를 하는 API 테스트를 다음과 같이 각각 작성한다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 3. 그래프 ---------------------------------</span>
<span class="kw">GET</span>(<span class="st">&quot;http://localhost:8000/spots/1900/graph&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">content</span>()</code></pre></div>
<pre class="output"><code>$error
$error[[1]]
[1] &quot;404 - Resource Not Found&quot;
</code></pre>
<h1 id="plumber-api-json">JSON 파일을 인자로 넘기는 경우</h1>
<h2 id="plumber-api-json-test">JSON 형태로 매개변수를 넘기는 API코드와 데이터</h2>
<p>인자를 JSON 파일형태로 지정하여 파일로 넘기는 경우 인자를 JSON으로 정리한다.</p>
<aside class="callout panel panel-info">
<div class="panel-heading">
<h3 id="data.json"><span class="glyphicon glyphicon-pushpin"></span>data.json</h3>
</div>
<div class="panel-body">
<p><code>data.json</code> 파일에 담기는 데이터 세부내용은 다음과 같다.</p>
<p><code>{&quot;Status.of.existing.checking.account&quot;: &quot;A11&quot;, &quot;Duration.in.month&quot;: 12, &quot;Credit.history&quot;: &quot;A32&quot;, &quot;Savings.account.bonds&quot;: &quot;A63&quot;}</code></p>
</div>
</aside>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#* @get /predict</span>
<span class="co">#* @post /predict</span>
predict.default.rate &lt;-<span class="st"> </span>function(
    Status.of.existing.checking.account
    , Duration.in.month
    , Credit.history
    , Savings.account.bonds
) {
    data &lt;-<span class="st"> </span><span class="kw">list</span>(
        <span class="dt">Status.of.existing.checking.account=</span>Status.of.existing.checking.account
        , <span class="dt">Duration.in.month=</span>Duration.in.month
        , <span class="dt">Credit.history=</span>Credit.history
        , <span class="dt">Savings.account.bonds=</span>Savings.account.bonds
    )
    prediction &lt;-<span class="st"> </span><span class="kw">predict</span>(decision.tree, data)
    <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">default.probability=</span><span class="kw">unbox</span>(prediction[<span class="dv">1</span>, <span class="dv">2</span>])))
}</code></pre></div>
<h2 id="plumber-api-json-test">JSON 형태 파일을 받는 API 테스트</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 4. 파일 ---------------------------------</span>
## 4.1. JSON 파일: 레코드 1개
<span class="co"># curl --data &quot;@data.json&quot; localhost:8000/predict</span>

<span class="kw">POST</span>(<span class="st">&quot;http://localhost:8000/predict&quot;</span>, <span class="dt">body=</span><span class="kw">upload_file</span>(<span class="st">&quot;data.json&quot;</span>)) %&gt;%
<span class="st">    </span><span class="kw">content</span>()</code></pre></div>
<pre class="output"><code>$error
$error[[1]]
[1] &quot;404 - Resource Not Found&quot;
</code></pre>
<h1 id="intro-to-plumber"><code>plumber</code> 팩키지 맛보기</h1>
<p><code>plumber</code> 팩키지를 사용하게 되면 로컬컴퓨터에 웹서버를 띄워 간단하게 웹상에서 R을 사용한다는 의미를 체험하는데 최적이다. 이것이 마음에 들면 확장하여 실운영환경으로 적용해서 최근 활발히 사용하고 있다.</p>
<h2 id="config-webserver-plumber">환경설치 및 R 웹서버 띄우기</h2>
<p><code>devtools::install_github(&quot;trestletech/plumber&quot;)</code> 명령어로 R 웹서버를 띄우고 나서, <code>myfile.R</code>에 웹서버를 통해 노출할 함수를 지정하면 된다. 그리고 나서 <code>r$run(port=8000)</code> 명령어를 실행하면 실제로 웹서버에 노출한 함수를 곧바로 활용할 수 있다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">&quot;trestletech/plumber&quot;</span>)

<span class="kw">library</span>(plumber)

r &lt;-<span class="st"> </span><span class="kw">plumb</span>(<span class="st">&quot;code/myfile.R&quot;</span>) 
r$<span class="kw">run</span>(<span class="dt">port=</span><span class="dv">8000</span>)
Starting server to listen on port <span class="dv">8000</span>
Running the swagger UI at http:<span class="er">//</span><span class="fl">127.0.0.1</span>:<span class="dv">8000</span>/__swagger__/</code></pre></div>
<h2 id="plumber-services">R 웹서버에서 제공하는 서비스</h2>
<p><code>@get</code>, <code>@post</code> 두가지 사례를 <code>normalMean</code>, <code>addTwo</code> 함수를 <code>mean</code>, <code>sum</code>을 통해 서비스로 제공하고 있다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#* @get /mean</span>
normalMean &lt;-<span class="st"> </span>function(<span class="dt">samples=</span><span class="dv">10</span>){
    data &lt;-<span class="st"> </span><span class="kw">rnorm</span>(samples)
    <span class="kw">mean</span>(data)
}

<span class="co">#* @post /sum</span>
addTwo &lt;-<span class="st"> </span>function(a, b){
    <span class="kw">as.numeric</span>(a) +<span class="st"> </span><span class="kw">as.numeric</span>(b)
}</code></pre></div>
<h2 id="plumber-in-service">실행 사례</h2>
<p><code>curl &quot;http://localhost:8000/mean&quot;</code> 명령어를 실행시키면 <code>localhost</code>, 8000포트를 통해 <code>mean</code> 서비스가 요청되고, 기본설정된 매개변수 <code>sample=10</code>이 전달되어 표준정규분포에서 표본을 10개 뽑아 평균을 계산하고 출력결과를 반환시킨다.</p>
<p><code>curl --data '{&quot;a&quot;:4, &quot;b&quot;:5}' http://localhost:8000/sum</code> 명령어를 실행시키면 <code>localhost</code>, 8000포트를 통해 <code>sum</code> 서비스를 json 형식 데이터를 전달하여, 두값을 더한 후 결과값을 반환시킨다.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">$<span class="st"> </span>curl <span class="st">&quot;http://localhost:8000/mean&quot;</span>
[-<span class="fl">0.6062</span>]
$<span class="st"> </span>curl <span class="st">&quot;http://localhost:8000/mean?samples=1000&quot;</span>
[-<span class="fl">0.0021</span>]
$<span class="st">  </span>curl --data <span class="st">&quot;a=4&amp;b=3&quot;</span> <span class="st">&quot;http://localhost:8000/sum&quot;</span>
[<span class="dv">7</span>]
$<span class="st"> </span>curl --data <span class="st">&#39;{&quot;a&quot;:4, &quot;b&quot;:5}&#39;</span> http:<span class="er">//</span>localhost:<span class="dv">8000</span>/sum
[<span class="dv">9</span>]</code></pre></div>
<h1 id="plumber-api-files">전체 파일</h1>
<p><code>plumber</code> RESTful API 서비스는 <code>plumber-api.R</code> 파일에 제공되는 서비스가 명세되고, <code>serve-api.R</code> 파일에 <code>plumber</code> 서비스 실행 코드가 담겨진다.</p>
<h2 id="plumber-api-files-services"><code>plumber-api.R</code> 파일</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 0. 환경설정 -----</span>
<span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(plumber)
<span class="kw">library</span>(dygraphs)

MODEL_VERSION &lt;-<span class="st"> &quot;0.0.1&quot;</span>

VARIABLES &lt;-<span class="st"> </span><span class="kw">list</span>(
    <span class="dt">var_01 =</span> <span class="st">&quot;var_01 = 1, 2, 3&quot;</span>,
    <span class="dt">var_02 =</span> <span class="st">&quot;var_02 = dummy variable, (x party, y party)&quot;</span>,
    <span class="dt">var_03 =</span> <span class="st">&quot;var_03 = integer number&quot;</span>,
    <span class="dt">gap =</span> <span class="st">&quot;&quot;</span>,
    <span class="dt">probability =</span> <span class="st">&quot;Successful submission will results in a calculated Probability from 0 to 1 (from Unlikely to More Likely)&quot;</span>)

<span class="co"># 1. HTML 정보제공 -----</span>
<span class="co">#* @get /</span>
<span class="co">#* @html</span>
home &lt;-<span class="st"> </span>function() {
    title &lt;-<span class="st"> &quot;Predictive Model Service API with Plumber&quot;</span>
    body_intro &lt;-<span class="st">  &quot;Welcome to the XXX Predictive Service API!&quot;</span>
    body_model &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;We are currently serving model version:&quot;</span>, MODEL_VERSION)
    body_msg &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;To received a prediction on xxxxx probability,&quot;</span>, 
                      <span class="st">&quot;submit the following variables to the &lt;b&gt;/predictive&lt;/b&gt; endpoint:&quot;</span>,
                      <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
    body_reqs &lt;-<span class="st"> </span><span class="kw">paste</span>(VARIABLES, <span class="dt">collapse =</span> <span class="st">&quot;&lt;br&gt;&quot;</span>)
    
    other_services_title &lt;-<span class="st"> &quot;Any Other Services&quot;</span>
    other_services &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;hello_world&quot;</span>, <span class="st">&quot;&lt;br&gt;&quot;</span>,
                            <span class="st">&quot;sum_two&quot;</span>,  <span class="st">&quot;&lt;br&gt;&quot;</span>,
                            <span class="st">&quot;ggplot2_density&quot;</span>, <span class="st">&quot;&lt;br&gt;&quot;</span>,
                            <span class="st">&quot;/iris/sp/n:int&quot;</span>, <span class="st">&quot;&lt;br&gt;&quot;</span>)
    
    result &lt;-<span class="st"> </span><span class="kw">paste</span>(
        <span class="st">&quot;&lt;html&gt;&quot;</span>,
        <span class="st">&quot;&lt;h1&gt;&quot;</span>, title, <span class="st">&quot;&lt;/h1&gt;&quot;</span>, <span class="st">&quot;&lt;br&gt;&quot;</span>,
        <span class="st">&quot;&lt;body&gt;&quot;</span>, 
        <span class="st">&quot;&lt;p&gt;&quot;</span>, body_intro, <span class="st">&quot;&lt;/p&gt;&quot;</span>,
        <span class="st">&quot;&lt;p&gt;&quot;</span>, body_model, <span class="st">&quot;&lt;/p&gt;&quot;</span>,
        <span class="st">&quot;&lt;p&gt;&quot;</span>, body_msg, <span class="st">&quot;&lt;/p&gt;&quot;</span>,
        <span class="st">&quot;&lt;p&gt;&quot;</span>, body_reqs, <span class="st">&quot;&lt;/p&gt;&quot;</span>,
        <span class="st">&quot;&lt;br&gt;&quot;</span>,
        <span class="st">&quot;&lt;h1&gt;&quot;</span>, other_services_title, <span class="st">&quot;&lt;/h1&gt;&quot;</span>, <span class="st">&quot;&lt;br&gt;&quot;</span>,
        <span class="st">&quot;&lt;p&gt;&quot;</span>, other_services, <span class="st">&quot;&lt;/p&gt;&quot;</span>,
        <span class="st">&quot;&lt;/body&gt;&quot;</span>,
        <span class="st">&quot;&lt;/html&gt;&quot;</span>,
        <span class="dt">collapse =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>
    )
    
    <span class="kw">return</span>(result)
}


<span class="co"># 2. Hello World -----</span>
<span class="co">#* @get /hello_world</span>
hello_world &lt;-<span class="st"> </span>function() {
    <span class="kw">return</span>(<span class="st">&quot;Welcom to the Plumber API&quot;</span>)
}

<span class="co"># 3. 매개변수 사례 -----</span>
<span class="co">#* @post /sum_two</span>
plus_operation &lt;-<span class="st"> </span>function(a, b) {
    <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">result =</span> <span class="kw">as.numeric</span>(a) +<span class="st"> </span><span class="kw">as.numeric</span>(b)))
}

<span class="co">#* @get /iris/&lt;sp&gt;/&lt;n:int&gt;</span>
function(n, sp) {
    iris %&gt;%<span class="st"> </span>dplyr::<span class="kw">filter</span>(Species ==<span class="st"> </span>sp) %&gt;%<span class="st"> </span>
<span class="st">        </span><span class="kw">slice</span>(n)
}

<span class="co"># 4. 정적그래프 사례 -----</span>
<span class="co">#* @get /ggplot2_density</span>
<span class="co">#* @png</span>
ggp2dens &lt;-<span class="st"> </span>function(<span class="dt">seed =</span> <span class="kw">rnorm</span>(<span class="dv">1</span>), <span class="dt">fill.colour =</span> <span class="st">&quot;tomato&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span>) {
    <span class="kw">library</span>(ggplot2)
    <span class="kw">set.seed</span>(seed)
    p &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">rnorm</span>(<span class="dv">100</span>)) %&gt;%<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(x)) +<span class="st"> </span>
<span class="st">        </span><span class="kw">geom_density</span>(<span class="dt">fill =</span> fill.colour, <span class="dt">alpha =</span> alpha)
    <span class="kw">print</span>(p)
}


<span class="co"># 5. 인터랙티브 그래프 사례 -----</span>
<span class="co">#&#39; @get /spots/&lt;year&gt;/graph</span>
<span class="co">#&#39; @serializer htmlwidget</span>
function(year){
    sunsplot_dygraph &lt;-<span class="st"> </span><span class="kw">dygraph</span>(datasets::sunspots, <span class="dt">main =</span> <span class="st">&quot;Sunspots&quot;</span>) %&gt;%
<span class="st">        </span><span class="kw">dyRangeSelector</span>(<span class="dt">dateWindow =</span> <span class="kw">c</span>(<span class="kw">paste0</span>(year,<span class="st">&quot;-01-01&quot;</span>),
                                       <span class="kw">paste0</span>(year,<span class="st">&quot;-12-31&quot;</span>))
        )
    <span class="kw">print</span>(sunsplot_dygraph)
}

<span class="co"># 6. 예측모형 사례 -----</span>
<span class="co">#* @get /predict</span>
<span class="co">#* @post /predict</span>
predict.default.rate &lt;-<span class="st"> </span>function(
    Status.of.existing.checking.account
    , Duration.in.month
    , Credit.history
    , Savings.account.bonds
) {
    data &lt;-<span class="st"> </span><span class="kw">list</span>(
        <span class="dt">Status.of.existing.checking.account=</span>Status.of.existing.checking.account
        , <span class="dt">Duration.in.month=</span>Duration.in.month
        , <span class="dt">Credit.history=</span>Credit.history
        , <span class="dt">Savings.account.bonds=</span>Savings.account.bonds
    )
    prediction &lt;-<span class="st"> </span><span class="kw">predict</span>(decision.tree, data)
    <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">default.probability=</span><span class="kw">unbox</span>(prediction[<span class="dv">1</span>, <span class="dv">2</span>])))
}</code></pre></div>
<h2 id="plumber-api-files-services-serve"><code>serve-api.R</code> 파일</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(plumber)

r &lt;-<span class="st"> </span><span class="kw">plumb</span>(<span class="st">&quot;code/helloworld/plumber_api.R&quot;</span>)

r$<span class="kw">run</span>(<span class="dt">port=</span><span class="dv">8000</span>)</code></pre></div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><span class="citation">[PLUMBER - TURN R CODE INTO WEB APIS, Jeff Allen @trestleJeff]</span>(https://plumber.trestletech.com/components/earl-2015/)<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p><a href="https://www.lesstif.com/pages/viewpage.action?pageId=14745703">curl 설치 및 사용법 - HTTP GET/POST, REST API 연계등</a><a href="#fnref2">↩</a></p></li>
</ol>
</div>
        </div>
      </div>
      </article>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/swcarpentry/lesson-template">Source</a>
        <a class="label swc-blue-bg" href="mailto:admin@software-carpentry.org">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-37305346-2', 'auto');
      ga('send', 'pageview');
    
    </script>
  </body>
</html>
