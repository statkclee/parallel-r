---
layout: page
title: R 병렬 프로그래밍
subtitle: RESTful API 개발환경 - plumber
output:
  html_document: 
    toc: yes
    toc_float: true
    highlight: tango
    number_section: true
    code_folding: show
mainfont: NanumGothic
---

``` {r, include=FALSE}
source("tools/chunk-options.R")
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)

library(tidyverse)
library(httr)
library(plumber)
options(scipen = 999)
options(dplyr.width = 120)
options(dplyr.print_max = 1e9)
```


# RESTful API 테스트 [^plumber-restful-api-earl-2015] {#plumber-api-test}

[^plumber-restful-api-earl-2015]: [PLUMBER - TURN R CODE INTO WEB APIS, Jeff Allen @trestleJeff](https://plumber.trestletech.com/components/earl-2015/)

R 코드를 RESTful API 서비스로 제공하고자 할 경우 정말 훌륭한 서비스를 만드는 것도 중요하지만, 
결국 시작은 헬로월드를 찍는 것부터 시작된다. 즉, RESTful API로 개발된 결과물을 빨리 확인할 수 있는 통합개발환경이 중요한 역할을 담당하게 된다.

# 헬로월드 {#plumber-api-test-hello}

가장 먼저 `hello_world` 함수를 `/hello_world` 서비스로 제공한다.
`httr` 팩키지 `GET` 함수를 활용하여 웹브라우져를 열어 테스트하는 대신 RStudio 개발환경에서 일원화하여 개발속도를 가속시킨다.

## 헬로월드 서비스 코드 {#plumber-api-hello-world}

``` {r plumber-restful-api-hello-world, eval=FALSE}
#* @get /hello_world
hello_world <- function() {
    return("안녕하세요... 반갑습니다.")
}
```

## 헬로월드 서비스 호출 및 테스트 {#plumber-api-hello-world-call} 

``` {r plumber-restful-api-hello-world-test}
# 0. 환경설정 ---------------------------------
library(httr)
library(tidyverse)

# 1. 헬로 월드: GET ---------------------------------
GET("http://localhost:8000/hello_world") %>% 
    content()
```

## 매개변수 넘기는 경우 {#plumber-api-hello-world-parameter}

단순히 서비스를 호출하는 대신에 인증을 위해 `ID`, `비밀번호`등을 넘기는 경우도 흔하다.
이런 경우 인자를 넘기는 방식이 다양하다.
POST를 전통적으로 `?`로 시작해서 인자를 넘긴다고 지정하고 다수 매개변수를 넘길 때 매개변수를 `&`로 구분해서 넘긴다.

혹은 POST 내부 인자로 `query`를 사용해서 `list` 자료형으로 넘기는 것도 가능하고,
`path`에 지정하는 것도 가능하다.

### 매개변수 넘기는 API {#plumber-api-hello-world-parameter-01} 

``` {r plumber-restful-api-parameter, eval=FALSE}
#* @post /sum_two
plus_operation <- function(a, b) {
    return(list(result = as.numeric(a) + as.numeric(b)))
}

#* @get /iris/<sp>/<n:int>
function(n, sp) {
    iris %>% dplyr::filter(Species == sp) %>% 
        .[as.integer(n), ]
}
```

### 매개변수 넘기는 API 테스트 {#plumber-api-hello-world-parameter-test}


``` {r plumber-restful-api-parameter-test}
# 2. 매개변수 넘기기: POST ---------------------------------
## 2.1. 매개변수 2개 넘겨 더하기
POST("http://localhost:8000/sum_two?a=1&b=2") %>% 
    content()

POST("http://localhost:8000/sum_two", query=list(a=1, b=3)) %>% 
    content()

## 2.2. 깔끔한 매개변수 넘기기
GET("http://localhost:8000", path = "iris/virginica/3") %>% 
    content()
```

# 그래프 {#plumber-api-graph}

## 그래프 시각화를 하는 API {#plumber-api-graph-viz} 

R의 강점인 그래프도 가능하다.

``` {r plumber-restful-api-graph, eval=FALSE}
#* @get /ggplot2_density
#* @png

ggp2dens <- function(seed = rnorm(1), fill.colour = "tomato", alpha = 1) {
    library(ggplot2)
    set.seed(seed)
    p <- data.frame(x = rnorm(100)) %>% ggplot(aes(x)) + 
        geom_density(fill = fill.colour, alpha = alpha)
    print(p)
}
```

## 그래프 시각화를 하는 API  테스트 {#plumber-api-graph-test}

``` {r plumber-restful-api-graph-test}
# 3. 그래프 ---------------------------------
plot(0:1, 0:1, type = "n")
GET("http://localhost:8000/ggplot2_density?seed=77&fill.colour=tomato&alpha=0.5") %>% 
    content() %>% rasterImage(0, 0, 1, 1)
```

# JSON 파일을 인자로 넘기는 경우 {#plumber-api-json}

## JSON 형태로 매개변수를 넘기는 API코드와 데이터 {#plumber-api-json-test}

인자를 JSON 파일형태로 지정하여 파일로 넘기는 경우 인자를 JSON으로 정리한다.

> ### data.json {.callout}
>
> `data.json` 파일에 담기는 데이터 세부내용은 다음과 같다.
> 
> 
> `{"Status.of.existing.checking.account": "A11", "Duration.in.month": 12, "Credit.history": "A32", "Savings.account.bonds": "A63"}`

``` {r plumber-restful-api-json, eval=FALSE}
#* @post /predict
predict.default.rate <- function(
    Status.of.existing.checking.account
    , Duration.in.month
    , Credit.history
    , Savings.account.bonds
) {
    data <- list(
        Status.of.existing.checking.account=Status.of.existing.checking.account
        , Duration.in.month=Duration.in.month
        , Credit.history=Credit.history
        , Savings.account.bonds=Savings.account.bonds
    )
    prediction <- predict(decision.tree, data)
    return(list(default.probability=unbox(prediction[1, 2])))
}
```

## JSON 형태 파일을 받는 API 테스트 {#plumber-api-json-test} 

``` {r plumber-restful-api-json-test}
# 4. 파일 ---------------------------------
## 4.1. JSON 파일: 레코드 1개
# curl --data "@data.json" localhost:8000/predict

POST("http://localhost:8000/predict", body=upload_file("data.json")) %>%
    content()
```

# `plumber` 팩키지 맛보기 {#intro-to-plumber}

`plumber` 팩키지를 사용하게 되면 로컬컴퓨터에 웹서버를 띄워 간단하게 웹상에서 R을 사용한다는 의미를 체험하는데 최적이다. 
이것이 마음에 들면 확장하여 실운영환경으로 적용해서 최근 활발히 사용하고 있다.


## 환경설치 및 R 웹서버 띄우기 {#config-webserver-plumber}

`devtools::install_github("trestletech/plumber")` 명령어로 R 웹서버를 띄우고 나서,
`myfile.R`에 웹서버를 통해 노출할 함수를 지정하면 된다. 그리고 나서 `r$run(port=8000)` 명령어를 실행하면 실제로 웹서버에 
노출한 함수를 곧바로 활용할 수 있다.

``` {r plumber-webserver, eval=FALSE}
devtools::install_github("trestletech/plumber")

library(plumber)

r <- plumb("code/myfile.R") 
r$run(port=8000)
Starting server to listen on port 8000
Running the swagger UI at http://127.0.0.1:8000/__swagger__/
```

## R 웹서버에서 제공하는 서비스 {#plumber-services}

`@get`, `@post` 두가지 사례를 `normalMean`, `addTwo` 함수를 `mean`, `sum`을 통해 서비스로 제공하고 있다.

``` {r plumber-function, eval=FALSE}
#* @get /mean
normalMean <- function(samples=10){
    data <- rnorm(samples)
    mean(data)
}

#* @post /sum
addTwo <- function(a, b){
    as.numeric(a) + as.numeric(b)
}
```

## 실행 사례 {#plumber-in-service}

`curl "http://localhost:8000/mean"` 명령어를 실행시키면 `localhost`, 8000포트를 통해 `mean` 서비스가 요청되고, 
기본설정된 매개변수 `sample=10`이 전달되어 표준정규분포에서 표본을 10개 뽑아 평균을 계산하고 출력결과를 반환시킨다.

`curl --data '{"a":4, "b":5}' http://localhost:8000/sum` 명령어를 실행시키면 `localhost`, 
8000포트를 통해 `sum` 서비스를 json 형식 데이터를 전달하여, 두값을 더한 후 결과값을 반환시킨다.


``` {r plumber-run-localserver, eval=FALSE}
$ curl "http://localhost:8000/mean"
[-0.6062]
$ curl "http://localhost:8000/mean?samples=1000"
[-0.0021]
$  curl --data "a=4&b=3" "http://localhost:8000/sum"
[7]
$ curl --data '{"a":4, "b":5}' http://localhost:8000/sum
[9]
```
